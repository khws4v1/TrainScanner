#TrainScannerの使い方
##新機能

* 動画の代わりにtsconfファイル(TrainScanner consifuration file; 設定内容が書かれたファイル)を読みこめるようになりました．(ただし，頭出しの情報だけは読みこめません．)

##インストール
[DropBox](https://www.dropbox.com/sh/3a1p84nqxz1b7b3/AACdmHd9jVsqVgU9Nj2TZ2oYa?dl=0)にてアプリを配布しています．Mac app is available at [DropBox](https://www.dropbox.com/sh/3a1p84nqxz1b7b3/AACdmHd9jVsqVgU9Nj2TZ2oYa?dl=0).

当面，Mac用を配布します．TrainScannerはPythonで書かれているので，Windows/Linuxにも容易に移植できるはずですが，開発者の手が回っていません．協力を募集しています．
##撮影方法
列車をビデオカメラで側面から撮影します。

* 必ず三脚を使用して下さい。手振れすると、最終的な列車の写真がぐにゃぐにゃになります。
* プラットホームでの三脚の利用を禁じている駅があります。いろいろ工夫してみて下さい。

ほかにもいろいろアドバイスはありますが、はじめは気にしなくても大丈夫です。
##TrainScannerで開く
1. まず、「ムービーを開く」を押してムービーファイルを開いて下さい。主要なフォーマットであればそのまま開けますが、開けない場合は、QuickTimeやffmpegなどを利用してフォーマットを変換してから再挑戦して下さい。

![settings](https://github.com/vitroid/TrainScanner/blob/master/images_ja/settings.png?raw=true)

1. ファイルが無事に開くと、大きなダイアログ画面が表示されます。一番上が頭出しのためのスナップショット表示窓、左が列車の歪みを修正するための窓、そして右が動きを検出する枠を指定するための窓です。この順番で作業します。

![edit1](https://github.com/vitroid/TrainScanner/blob/master/images_ja/edit1.png?raw=true)

1. まず、一番上の窓で、スライダーを使って、列車が視野に入りかける瞬間を指定して下さい。下の左右の窓には、指定されたフレームが表示されます。
 
![edit1b](https://github.com/vitroid/TrainScanner/blob/master/images_ja/edit1b.png?raw=true)

1. 縦位置で撮影した場合や、カメラが傾いている(あるいはローリングシャッターで画像が傾いている)場合には、左窓下のボタンで画像を回転して、列車の窓枠が垂直になるようにして下さい。(水平は別の方法でも調節できます。)

![edit2a](https://github.com/vitroid/TrainScanner/blob/master/images_ja/edit2a.png?raw=true)

1. 左窓の四隅にあるスライダーを使って、画面内の赤い線が列車に平行になるように調節して下さい。右の窓に表示される列車が、水平になるまで調整します。この作業は省略しても構いません。

![edit2b](https://github.com/vitroid/TrainScanner/blob/master/images_ja/edit2b.png?raw=true)

1. 右の窓では、列車の動きを検知する枠を指定します。初期設定では視野の上下左右1/3の中央部分が指定されていますが、うまく動きを検知できない場合は、枠を指定しなおして下さい。
1. 右の窓の赤い縦線の位置が、スリットの位置です。つまり、この赤い線に沿った細長い写真の短冊を並べることで、長い列車の写真ができます。赤い線の位置は、右窓下のスライダーで動かせます。背景にあわせて、スリットの位置を決めて下さい。

![edit2c](https://github.com/vitroid/TrainScanner/blob/master/images_ja/edit2c.png?raw=true)


##TrainScannerでつなぐ
ここまで終わったら、ためしにつないでみましょう。

1. 小さい方のウィンドウに戻り、「開始」ボタンを押して下さい。まず連結作業の途中経過を表示するウィンドウが開き、しろい奇妙な映像が表示されます。この映像は、連続する2つの画像をずらしてかさねあわせた差を表示しています。完全に重なれば真っ白ですが、写真にずれがあると色が出現します。列車の動きを正確に捉えていれば、列車は真っ白になり、背景部分に色が出現しますが、列車の動きをとらえそこねていると、逆に背景が真っ白になって列車が色付きになります。列車が移動している間、動きを検知する枠(緑の長方形)の中ができるだけ真っ白になるように、枠の位置を選ぶと、きれいなしあがりになります。(注意: 今のところ，最初のコマまで早送りするのにとても時間がかかります．OpenCV2の頭出し命令が非常に不正確なため，1コマずつ頭からスキップしているためです．)
1. 連結作業がおわったら、プレビューウィンドウが開きます。プレビューウィンドウにはスクロールバーがついていて、列車の写真が作られる過程を見られます。プレビューがおわったら、できあがった画像はもとのムービーファイルと同じフォルダに出力されます。ファイル名は、もとのムービーのファイル名に拡張子 “.png”が付いたものになります。

##良い仕上りのために
小さいほうのウィンドウには、いくつか設定項目があります。

* 「スリットのつなぎ目」短冊と短冊をつなぎあわせる時に、あわせめの重ねる幅を指定します。小さくするとシャープになりますが、水平のずれが目立つことになるかもしれません。大きくすると背景がならされてスムーズになります。
* 「フレーム間の移動距離の最小値」列車の動きがこの数字よりも小さい場合には、列車は動いていないものとみなされます。カメラが微妙に動いている場合には大きめに設定すると良いでしょう。
* 「縦方向のずれを無視する」傾き補正を行っても、列車の動きが完全に水平ではなく、徐々に上下位置がずれていってしまう場合には、これをクリックすると、強制的に上下の動きを無視します。デフォルトではオンになっていますが、船など上下の動きが大きい物体の場合にはオフにしましょう。
* 「最初、列車は移動検知窓の中に止まっている」特殊な状況として、静止状態から撮影する場合にはこれをチェックして下さい。TrainScannerは、移動検知窓には突然列車が飛びこんでくると想定し、突然の大きな動きから列車の初速を推定します。しかし、はじめから視野に列車が静止している場合には、この推定機構がかえって邪魔になる(大きな動きになるまで無視してしまう)ので、速度推定機構をオフにします。
* 「列車が去ったあともスキャンを継続する」これを大きくすると、列車が去ったあとも、しばらくは列車の速度にあわせてつなぎあわせを続けます。短くすると、すぐにスキャンを打ち切ります。
* 「フィルムの縁をつける」フィルム写真のような、ミシン目をつけます。
* 「らせん画像を作る」列車の長い写真が、通常の紙におさまるように再配置します。紙に印刷したあとで丸めてのり付けして円筒を作り、列車にそって切ると簡単に長い写真が作れます。

##印刷について

列車の写真は非常に長くなるので，印刷には一工夫必要です．

* インクジェットプリンタのなかには，ロール紙に対応しているものがあります．(エプソン)対応機種では，プリントアウトする際に，用紙の長さを任意に指定できますので，紙幅にあわせて，用紙サイズを指定して印刷します．ロール紙フォルダは通常オプションパーツですが，ティッシュの箱と鉛筆で，簡単に自作できます．また，ロール紙は20巻で2000円ぐらいで手に入ります．
* 前章の「らせん画像を作る」を選ぶと，A4ランドスケープにちょうどおさまるように，写真の大きさを自動調整してくれます．シール紙やマグネット紙など，いろんな素材が選べるので，いろいろ用途を考えてみて下さい．

##その他のアドバイス

* 暗い場所で撮影する場合は、ISO感度を大きくするなどして、シャッタースピードをできるだけ短くして下さい。
* 視野に突然高速で入ってくる列車に対し、オートフォーカスはあまり上手く働かないようです。あらかじめ線路などで合焦して固定しておきましょう。明るさもあらかじめ固定しておきましょう。
* 高速で動くものを、横位置(ランドスケープ)で撮影すると、動いているものだけが傾いてしまうことがあります(ローリングシャッター現象)。解像度をかせぐためにも、縦位置(ポートレート)で撮影しましょう。
* 車体に影がうつりこまないようにしましょう。日向で撮影する場合は、逆光で撮影したほうが、車体上に影ができなくてよいようです。
* 移動検知窓の範囲内に影や反射があると、TrainScannerは動きを検知しそこなうことがあります。特急列車のようにピカピカのボディはけっこうやっかいです。

##現在わかっている問題点

* seekが遅い．OpenCVにはビデオを早送りする機能がありますが，これが全く信頼できないので，頭から毎回1コマずつ読みこんでいます．

##内部動作(アルゴリズム)

TrainScannerでは，ビデオフレーム間の列車の移動距離を求めるのに，単純な比較を行っています．OpenCVを使用してはいるのですが，以下の理由により，最近はやりの特徴点抽出は使っていません．

* 特徴点で比較すると，ときどき照合の失敗が起こります．特に，上に書いたように，列車の表面に影が写りこんでいたり，窓や斜体が反射する場合には，失敗する可能性が高まります．
* 列車はほぼ一定速度で走っていて，加速や減速もほとんどないので，次のフレームでの移動が極めて正確に予測でき，その結果照合する範囲もぎりぎりまで狭められます．このため，単純な照合を行っても，処理時間はごくわずかですみます．照合はあらかじめ指定された枠の中だけで行うので，写真が大きくても処理は軽いです．

##Revision History

* 2016-11-19 Version 0.2: 設定ファイルを引きつげるようにした．オプションの取り扱いを改善した．設定ファイルの出力のしかたを変更した．などなど．
* 2016-11-11 GUI Version 0.1 is released.
